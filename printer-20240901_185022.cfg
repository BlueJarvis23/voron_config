[skew_correction]

[mcu]
canbus_uuid: 5691b69676e8
#Old config before CANbus
#serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_0F0015000350534E4E313120-if00
#restart_method: command

#[mcu ercf_can]
#canbus_uuid: f4613b33544c

[mcu sb2209]
canbus_uuid: 17cd163d2cf7

#[mcu btt_mmb_can]
#canbus_uuid: 62d8875e1d46

#[mcu carto3d]
#canbus_uuid: cb3cd159c35a

# SB2040 config
#[mcu sb2040]
#canbus_uuid: b3a8b2208507

## Used for additional temp sensors
[mcu rpi]
serial: /tmp/klipper_host_mcu

#### FANS
[fan]
##  Print Cooling Fan - FAN0
pin: sb2209:PA1
#tachometer_pin: ^sb2040:gpio17
#tachometer_ppr: 2
#tachometer_poll_interval: 0.006
kick_start_time: 0.5
off_below: 0.10

[heater_fan hotend_fan]
##  Hotend Fan - FAN1
pin: sb2209:PA0
tachometer_pin: ^sb2209:PB15
kick_start_time: 0.5
max_power: 1.0
heater: extruder
heater_temp: 50.0

[controller_fan electronics_bay]
pin: PD12
max_power: 0.50
shutdown_speed: 0
kick_start_time: 1.0
heater: heater_bed, extruder
stepper: stepper_x, stepper_y, stepper_z

#[temperature_fan sb_cooling]
#pin: sb2040:gpio15
#kick_start_time: 0.5
#off_below: 0.10

#control: watermark
# max_delta default of 2C was not enough and oscillations occurred
#max_delta: 5
#min_temp: 20
#target_temp: 40
#max_temp: 80
#sensor_type: NTC 100K MGB18-104F39050L32
#sensor_pin: sb2040:gpio26
### END FANS

[exclude_object]

[respond]

[pause_resume]
recover_velocity: 300.0

# [adxl345]
# cs_pin: sb2209:PB12
# spi_software_sclk_pin: sb2209:PB10
# spi_software_mosi_pin: sb2209:PB11
# spi_software_miso_pin: sb2209:PB2

# [adxl345]
# cs_pin: rpi:None

# [resonance_tester]
# accel_chip: adxl345
# probe_points:
# 	150, 150, 20

[input_shaper]
shaper_type_x = mzv
shaper_freq_x = 50
shaper_type_y = mzv
shaper_freq_y = 37

[printer]
kinematics: corexy
max_velocity: 500  
max_accel: 5000             #Max 4000
max_z_velocity: 30          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0

#####################################################################
#   X/Y Stepper Settings
#####################################################################

##  B Stepper - Left
##  Connected to MOTOR_0
##  Endstop connected to DIAG_0

[stepper_x]
step_pin: PF13
dir_pin: !PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: ^sb2209:PB5
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 25   #Max 100
homing_retract_dist: 5
homing_positive_dir: true

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_x]
uart_pin: PC4
stealthchop_threshold: 0
# Reduced from 1.25 because got message that driver for stepper_y was overheating - OLD VALUES USED BEFORE TUNING MOTORS
#interpolate: false
#run_current: 1.10
#sense_resistor: 0.110

# LDO Motors 42STH48-2504AH NEMA 17 Stepper Motor - tuned with https://github.com/MakerBogans/docs/wiki/TMC-Driver-Tuning
interpolate: false
sense_resistor: 0.110
run_current: 1.1
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 7
driver_HEND: 9

# Third try with autotune - overheating on X and Y at 1.2 and overheating on Y with 1.1
#interpolate: true
#sense_resistor: 0.110
#run_current: 1.1
#[autotune_tmc stepper_x]
#motor: ldo-42sth48-2504ah

##  A Stepper - Right
##  Connected to MOTOR_1
##  Endstop connected to DIAG_1
[stepper_y]
step_pin: PG0
dir_pin: !PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: PG6
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 25  #Max 100
homing_retract_dist: 5
homing_positive_dir: true

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_y]
uart_pin: PD11
stealthchop_threshold: 0
# Reduced from 1.25 because got message that driver for stepper_y was overheating - OLD VALUES USED BEFORE TUNING MOTORS
#interpolate: false
#run_current: 1.10
#sense_resistor: 0.110

# LDO Motors 42STH48-2504AH NEMA 17 Stepper Motor - tuned with https://github.com/MakerBogans/docs/wiki/TMC-Driver-Tuning
# Overheated when set to 1.2A
interpolate: false
sense_resistor: 0.110
run_current: 1.1
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 7
driver_HEND: 9

# Third try with autotune
#interpolate: true
#sense_resistor: 0.110
#run_current: 1.1
#[autotune_tmc stepper_y]
#motor: ldo-42sth48-2504ah


#####################################################################
#   Z Stepper Settings
#####################################################################

## Z0 Stepper - Front Left
##  Connected to MOTOR_2
##  Endstop connected to DIAG_2
[stepper_z]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32
# Greg mod for Voron-Tap
# endstop_pin: PG10
# position_endstop = 0.859
endstop_pin: probe:z_virtual_endstop
position_max: 250
position_min: -5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 0

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z]
uart_pin: PC6
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999

##  Z1 Stepper - Rear Left
##  Connected to MOTOR_3
[stepper_z1]
step_pin: PG4
dir_pin: PC1
enable_pin: !PA0
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999

##  Z2 Stepper - Rear Right
##  Connected to MOTOR_4
[stepper_z2]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999

##  Z3 Stepper - Front Right
##  Connected to MOTOR_5
[stepper_z3]
step_pin: PC13
dir_pin: PF0
enable_pin: !PF1
rotation_distance: 40
gear_ratio: 80:16
microsteps: 32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z3]
uart_pin: PE4
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999


#####################################################################
#   Extruder
#####################################################################

##  Connected to MOTOR_6
##  Heater - HE0
##  Thermistor - T0
[extruder]
step_pin: sb2209:PD0
dir_pin: sb2209:PD1
enable_pin: !sb2209:PD2
##  Update value below when you perform extruder calibration
##  If you ask for 100mm of filament, but in reality it is 98mm:
##  rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / 100
##  22.6789511 is a good starting point
#rotation_distance: 21.8   #Bondtech 5mm Drive Gears - Tuned for exactly 100mm of filament when requested Afterburner/Clockwork
#rotation_distance: 22.7   #Bondtech 5mm Drive Gears - Stealthburner/Clockwork2
#rotation_distance: 22.44   #Bondtech 5mm Drive Gears - Stealthburner/Clockwork2

##  Update Gear Ratio depending on your Extruder Type
##  Use 50:17 for Afterburner/Clockwork (BMG Gear Ratio)
##  Use 80:20 for M4, M3.1
#gear_ratio: 50:10               #BMG Gear Ratio
#microsteps: 32
# G2E
rotation_distance: 47.088
gear_ratio: 9:1
microsteps: 16

full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: sb2209:PB13
##  Validate the following thermistor type to make sure it is correct
##  See https://www.klipper3d.org/Config_Reference.html#common-thermistors for additional options
# For Rapdio
sensor_type: ATC Semitec 104NT-4-R025H42G
# For V6 clone
#sensor_type: Generic 3950
sensor_pin: sb2209:PA3
min_temp: 10
max_temp: 270
max_power: 1.0
min_extrude_temp: 170
##  Try to keep pressure_advance below 1.0
#pressure_advance: 0.065 # for Afterburner/Clockwork
pressure_advance: 0.02 # for Stealthburner/Clockwork2
##  Default is 0.040, leave stock
# Adding 0.02 based on feedback from Weaslus in Discord
pressure_advance_smooth_time: 0.020

# FOR ERCF
max_extrude_only_distance: 200
max_extrude_cross_section: 50.0

##  E0 on MOTOR6
##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 extruder]
uart_pin: sb2209:PA15
interpolate: false
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
##  SSR Pin - HE1
##  Thermistor - TB
heater_pin: PA3
##  Validate the following thermistor type to make sure it is correct
##  See https://www.klipper3d.org/Config_Reference.html#common-thermistors for additional options
sensor_type: Generic 3950
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.8
min_temp: 0
max_temp: 120
pwm_cycle_time: 0.2

#####################################################################
#   Probe
#####################################################################

[scanner]
canbus_uuid: cb3cd159c35a            
#adjust to suit your scanner 
#serial: /dev/serial/by-id/usb-cartographer_cartographer_
x_offset: 0                          
#adjust for your offset
y_offset: 15                         
#adjust for your offset
calibration_method: touch 
sensor: cartographer
sensor_alt: carto
#alternate name to call commands. CARTO_TOUCH etc
scanner_touch_z_offset: 0.05         
#this is the default and will be overwritten and added to the DO NOT SAVE area by using UI to save z offset

[safe_z_home]
home_xy_position: 150, 150
z_hop: 10
z_hop_speed: 50

[firmware_retraction]
retract_length: 0.4
retract_speed: 30
unretract_extra_length: 0.4
unretract_speed: 30

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 2700

[quad_gantry_level]
gantry_corners:
  -60,-10
  360,370
points:
  50,25
  50,225
  250,225
  250,25
speed: 300
horizontal_move_z: 10
max_adjust: 10
retries: 5
retry_tolerance: 0.0075

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>


#####################################################################
#   Macros
#####################################################################

[gcode_macro _Greg_Vars]
variable_blacklight_state:               0
variable_caselight_white_state:          0
variable_caselight_police_state:         0
variable_keep_on_state:                  0
gcode:

[gcode_macro TOGGLE_KEEP_ON]
gcode:
    {% set keep_on_state = printer["gcode_macro _Greg_Vars"].keep_on_state %}
	{% if keep_on_state > 0 %}
		SET_GCODE_VARIABLE MACRO=_Greg_Vars VARIABLE=keep_on_state VALUE={ 0 }
		M117 After print ends printer will turn off.
		M118 After print ends printer will turn off.
		UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=2
	{% else %}
		SET_GCODE_VARIABLE MACRO=_Greg_Vars VARIABLE=keep_on_state VALUE={ 1 }
		M117 After print ends printer will stay on.
		M118 After print ends printer will stay on.
		UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=2
	{% endif %}

# [include cartographer_probe.cfg]
[include sb2209_adxl345_probe.cfg]

[include custom/printer-thermals.cfg]
## HACK OUT FOR TESTING
#[include stealthburner-leds.cfg]
[include stealthburner-led-effects.cfg]
[include custom/led-effects.cfg]

[include nozzle-scrub.cfg]
[include bedfans-dualcontrol.cfg]
[include fluidd_macros.cfg]
[include test-speed.cfg]

[display_status]

[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
number_of_results_to_keep: 10
keep_raw_csv: False
show_macros_in_webui: True
timeout: 300

#[include K-ShakeTune/*.cfg]
# Vibrations and Resonance Calibrations
#[include IS_shaper_calibrate.cfg]
#[include IS_vibrations_measurement.cfg]
## HACK OUT FOR TESTING
#[gcode_shell_command plot_graph]
#command: bash /home/spikeygg/plot_graphs.sh
#timeout: 300.0
#verbose: True

# ---=== To swap back to single spool ===---
# 1) comment out ercf_parameters, ercf_hardware, ercf_software includes below - LEAVE client_macros!
# 2) comment out ERCF_EJECT in the PRINT_END section
# 3) remove ERCF calls from slicer settings
#   3a ERCF_CHANGE_TOOL STANDALONE=1 TOOL={initial_extruder} in Start G-code
# For printing TPU:
# also remove the CLEAN_NOZZLE
# raise the print head like 0.250 from the bed
# disconnect the ERCF and feed the spool from above
# remove the side panel and keep the doors open

#ERCF stuff
## HACK OUT FOR TESTING
[include mmu/base/*.cfg]

# HACKED OUT mmu client_macros.cfg for greg_client_macros.cfg
[include mmu/optional/client_macros.cfg]
#[include greg_client_macros.cfg]
## HACK IN fluidd.cfg
#[include fluidd.cfg]

[include timelapse.cfg]

### OLD ERCF stuff -- to reinstate it, recreate the links in ~/klipper/klippy/extras
### spikeygg@voron:~/klipper/klippy/extras $ ls -ltr er*
### lrwxrwxrwx 1 spikeygg spikeygg     46 Dec  2  2022 ercf.py -> /home/spikeygg/ERCF-Software-V3/extras/ercf.py
### lrwxrwxrwx 1 spikeygg spikeygg     52 Jan 30  2023 ercf_servo.py -> /home/spikeygg/ERCF-Software-V3/extras/ercf_servo.py
### lrwxrwxrwx 1 spikeygg spikeygg     54 Feb 10  2023 ercf_encoder.py -> /home/spikeygg/ERCF-Software-V3/extras/ercf_encoder.py
### -rw-r--r-- 1 spikeygg spikeygg   5148 Mar 20  2023 ercf_servo.pyc
### -rw-r--r-- 1 spikeygg spikeygg  12337 Jun 16 07:56 ercf_encoder.pyc
### -rw-r--r-- 1 spikeygg spikeygg 141749 Aug  2 05:47 ercf.pyc
### spikeygg@voron:~/klipper/klippy/extras $


#[include ercf/client_macros.cfg]
#[include ercf/ercf_parameters.cfg]
#[include ercf/ercf_hardware.cfg]
#[include ercf/ercf_software.cfg]

[gcode_macro M600]
gcode:
    {% set X = params.X|default(50)|float %}
    {% set Y = params.Y|default(0)|float %}
    {% set Z = params.Z|default(10)|float %}
    SAVE_GCODE_STATE NAME=M600_state
    PAUSE
    G91
    G1 E-.8 F2700
    G1 Z{Z}
    G90
    G1 X{X} Y{Y} F4000
    G91
    G1 E-50 F1000
    RESTORE_GCODE_STATE NAME=M600_state

[gcode_macro TURN_ON_HOTEND]
description: Turn on the hot end to a specific temperature and wait for it to get to temp TEMP=250
gcode:
    {% set TEMP = params.TEMP|default(250)|float %}
	STATUS_HEATING_HOTEND
		M117 Heating Hot End to {TEMP}.
		M118 Heating Hot End to {TEMP}.
		UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=5
		M109 S{TEMP}
	STATUS_HEATING_HOTEND_END
	
[gcode_macro HOME_IF_NEEDED]
gcode:
	{% if printer.toolhead.homed_axes != "xyz" %}
		STATUS_HOMING
			M117 Perform Homing.
			M118 Perform Homing.
			UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=5
			G28
		STATUS_HOMING_END
	{% endif %}

[gcode_macro PERFORM_CORNER_PROBE_ACCURACY]
gcode:
	G0 X50 Y25 Z20 F4000
	PROBE_ACCURACY SAMPLES=30
	G0 X50 Y225 Z20 F4000
	PROBE_ACCURACY SAMPLES=30
	G0 X250 Y225 Z20 F4000
	PROBE_ACCURACY SAMPLES=30
	G0 X250 Y25 Z20 F4000
	PROBE_ACCURACY SAMPLES=30


[gcode_macro CENTER]
gcode:
	G90
	G0 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F7200
	
[gcode_macro CENTER_Z]
gcode:
	G90
	G0 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } Z{ printer.toolhead.axis_maximum.z/2 } F7200

[gcode_macro G32]
gcode:
	STATUS_OFF
	BED_MESH_CLEAR
	HOME_IF_NEEDED
	
	STATUS_LEVELING
		M117 Perform Quad Gantry Level.
		M118 Perform Quad Gantry Level.
		UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=5
		QUAD_GANTRY_LEVEL
	STATUS_LEVELING_END
	
	STATUS_HOMING
		M117 Perform Final Z-Homing.
		M118 Perform Final Z-Homing.
		UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=5
		G90
		G0 X150 Y150 F4000
		G28 Z						; Z may be slightly different after QGL
		PARK_HEAD_OVER_BUCKET
		BED_MESH_PROFILE load=default
	STATUS_HOMING_END
	STATUS_READY	

[delayed_gcode POWER_DOWN]
gcode:
	M117 Turning off Nevermore Fan and motors.
	M118 Turning off Nevermore Fan and motors.
	UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=5
 	SET_FAN_SPEED FAN=BedInner SPEED=0.0
	M18
	
[gcode_macro PRINT_START]
gcode:
	# Reset things like flow-rate, speed, etc.
	M220 S100
	M221 S100

	# Used to be in the slicer settings before printing.
	#G90
	#G0 Z30 F4000
	#G0 X150 Y150 F4000
	
	# Clear any timer to stop the nevermore fans
	UPDATE_DELAYED_GCODE ID=POWER_DOWN DURATION=0

	STATUS_PRINTING

[gcode_macro GREG_ON_PAUSE]
gcode:
	PARK_HEAD_OVER_BUCKET
	CRITICAL_ERROR
	
[gcode_macro GREG_ON_RESUME]
gcode:
	CRITICAL_ERROR_END

[gcode_macro GREG_ON_CANCEL]
gcode:
	PARK_HEAD_OVER_BUCKET

[gcode_macro PARK_HEAD_OVER_BUCKET]
# Relatively move Z up slightly, then put the head over the bucket.
gcode:
	G91
	G1 Z2 F4000
	G90
	G0 X105 Y299 F4000

[gcode_macro PRINT_END]
#	Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
	
	STATUS_BUSY
	M117 Moving toolhead to safe anti-stringing coords.
	M118 Moving toolhead to safe anti-stringing coords.
	UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=5
	{% set th = printer.toolhead %}
	{% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
	{% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
	{% set z_safe = [th.position.z + 75, th.axis_maximum.z]|min %}

	SAVE_GCODE_STATE NAME=STATE_PRINT_END

	M400							; wait for buffer to clear
	G92 E0							; zero the extruder
	G1 E-2.0 F3600					; retract filament

	G90								; absolute positioning
	G0 X{x_safe} Y{y_safe} Z{z_safe} F20000						; move nozzle to remove stringing
	G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 30} F4000	; park nozzle at rear
	STATUS_BUSY_END
	STATUS_PART_READY

    {% set keep_on_state = printer["gcode_macro _Greg_Vars"].keep_on_state %}
	{% if keep_on_state > 0 %}
		M117 Keeping the heaters and fans on.
		M118 Keeping the heaters and fans on.
		UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=5
	{% else %}	
		M117 Ejecting the last tool.
		M118 Ejecting the last tool.
		MMU_EJECT
		
		M117 Turning the heaters and eventually the fans off.
		M118 Turning the heaters and eventually the fans off.
		UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=5
		
		TURN_OFF_HEATERS
		# Prep the nevermore to turn off after some time
		UPDATE_DELAYED_GCODE ID=POWER_DOWN DURATION=900
		# Turn the nevermore back on to clean up the air
		SET_FAN_SPEED FAN=BedInner SPEED=1.0
	{% endif %}

	M107							; turn off part cooling fan

	# STATUS_PART_READY_END
	UPDATE_DELAYED_GCODE ID=STATUS_PART_READY_END_DELAYED DURATION=5
	
	# BED_MESH_CLEAR				; Removed by Greg -- I want to keep the bed_mesh
	RESTORE_GCODE_STATE NAME=STATE_PRINT_END


[delayed_gcode STATUS_PART_READY_END_DELAYED]
gcode:
	STATUS_PART_READY_END

[delayed_gcode _CLEAR_DISPLAY]
gcode:
	M117

[gcode_macro HEAT_SOAK]
description: Heats the bed and performs a soak. BED=110 DURATION=6 (minutes)

variable_target_bed_temp: 0
variable_stage: None ## heating -> soaking -> done -> None

## in seconds
variable_check_interval: 10
variable_soak_time_remaining: 0
variable_total_time_elapsed: 0

gcode:
    {% set BED = params.BED | default(110) | float %}
    {% set DURATION = (params.DURATION | default(6) | int) * 60 %} ## minutes to seconds

    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=target_bed_temp     VALUE={ BED }
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=stage               VALUE="'heating'"
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=soak_time_remaining VALUE={ DURATION }
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=total_time_elapsed  VALUE=0

    ;; fire up the heater
	STATUS_HEATING_BED
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={ BED }
	HOME_IF_NEEDED
	CENTER

    UPDATE_DELAYED_GCODE ID=heat_soaker DURATION={ check_interval }

[gcode_macro CANCEL_HEAT_SOAK]
description: Cancels an in-progress HEAT_SOAK cycle
gcode:
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=stage VALUE="'cancel'"
    UPDATE_DELAYED_GCODE ID=heat_soaker DURATION=1

[delayed_gcode heat_soaker]
## debug
# { action_respond_info( printer['gcode_macro HEAT_SOAK'] | tojson )}
gcode:
    {% set heat_soak = printer['gcode_macro HEAT_SOAK'] %}

    ## update total time elapsed
    {% set total_time_elapsed = heat_soak.total_time_elapsed + heat_soak.check_interval %}
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=total_time_elapsed VALUE={ total_time_elapsed }

    {% set stage = heat_soak.stage %}
    {% if stage == "heating" and printer.heater_bed.temperature >= heat_soak.target_bed_temp %}
        {% set stage = "soaking" %}
		STATUS_HEATING_BED_END
		STATUS_HEAT_SOAKING
    {% endif %}

    {% if stage == "soaking" %}
        ## update soak countdown
        {% set soak_time_remaining = [heat_soak.soak_time_remaining - heat_soak.check_interval, 0] | max %}
        SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=soak_time_remaining VALUE={ soak_time_remaining }

        {% if soak_time_remaining == 0 %}
            {% set stage = "done" %}
        {% endif %}
    {% endif %}

    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=stage VALUE="'{ stage }'"

    {% if stage in ("done", "cancel") %}

        {% if stage == "cancel" %}
            {% set stage = "done" %}
            M117 { "soak cancelled after ~%.1fm" | format(total_time_elapsed / 60.0) }
            M118 { "soak cancelled after ~%.1fm" | format(total_time_elapsed / 60.0) }
			STATUS_HEAT_SOAKING_END
        {% else %}
            M117 { "soak complete after %.1fm" | format(total_time_elapsed / 60.0) }
            M118 { "soak complete after %.1fm" | format(total_time_elapsed / 60.0) }
			STATUS_HEAT_SOAKING_END
			SOAK_COMPLETE
        {% endif %}

        ## reset all state vars, except stage, which may be queried via the api
        SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=target_bed_temp     VALUE=0
        SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=soak_time_remaining VALUE=0
        SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=total_time_elapsed  VALUE=0

    {% else %}

        {% if total_time_elapsed % 90 == 0 %}
            ## output status periodically
            {% if stage == "heating" %}
                M117 { "heating -- %.1fm elapsed" | format(total_time_elapsed / 60.0) }
                M118 { "heating -- %.1fm elapsed" | format(total_time_elapsed / 60.0) }
            {% elif stage == "soaking" %}
                M117 { "soaking -- %.1fm remaining" | format(soak_time_remaining / 60.0) }
                M118 { "soaking -- %.1fm remaining" | format(soak_time_remaining / 60.0) }
            {% endif %}
        {% endif %}

        ## trigger ourselves again
        UPDATE_DELAYED_GCODE ID=heat_soaker DURATION={ heat_soak.check_interval }

        ## dwell for 1ms to prevent from going idle
        G4 P1

    {% endif %}

[gcode_macro SOAK_COMPLETE]
description: Finish the soak command
gcode:
	TURN_ON_HOTEND TEMP=150
	G32
#	TURN_ON_HOTEND

[bed_mesh]
speed: 300
horizontal_move_z: 10
mesh_min: 40, 40
mesh_max: 260,260
fade_start: 0.6
fade_end: 10.0
probe_count: 13,13
algorithm: bicubic
zero_reference_position: 150, 150
adaptive_margin: 5
#relative_reference_index: 12

### ORIG Z_OFFSET
#### z_offset = -1.050 (nozzle about 0.1mm too close)
### TRYING
#### z_offset = -0.950 (nozzle closer to bed)
### TRYING
#### z_offset = -1.150 (almost perfect)
#### z_offset = -1.200

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 24.122
#*# pid_ki = 2.513
#*# pid_kd = 57.894
#*#
#*# [bed_mesh Cold bed second mesh after QGL]
#*# version = 1
#*# points =
#*# 	0.025000, 0.031250, 0.038750, 0.030000, 0.032500
#*# 	-0.012500, -0.016250, 0.005000, -0.007500, -0.023750
#*# 	-0.020000, -0.015000, 0.000000, -0.012500, -0.045000
#*# 	0.015000, 0.016250, 0.028750, 0.020000, 0.005000
#*# 	0.020000, 0.021250, 0.040000, 0.048750, 0.020000
#*# tension = 0.2
#*# min_x = 40.0
#*# algo = bicubic
#*# y_count = 5
#*# mesh_y_pps = 2
#*# min_y = 40.0
#*# x_count = 5
#*# max_y = 260.0
#*# mesh_x_pps = 2
#*# max_x = 260.0
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 53.307
#*# pid_ki = 1.786
#*# pid_kd = 397.800
#*#
#*# [bed_mesh old default]
#*# version = 1
#*# points =
#*# 	0.015000, 0.023750, 0.035000, 0.025000, 0.026250
#*# 	-0.021250, -0.023750, -0.002500, -0.008750, -0.015000
#*# 	-0.022500, -0.016250, 0.000000, 0.001250, -0.030000
#*# 	0.012500, 0.020000, 0.032500, 0.027500, 0.015000
#*# 	0.013750, 0.023750, 0.047500, 0.046250, 0.021250
#*# tension = 0.2
#*# mesh_x_pps = 2
#*# algo = bicubic
#*# min_x = 40.0
#*# min_y = 40.0
#*# y_count = 5
#*# mesh_y_pps = 2
#*# x_count = 5
#*# max_x = 260.0
#*# max_y = 260.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.040000, 0.077500, 0.058750, 0.043750, 0.041250
#*# 	-0.021250, -0.016250, -0.001250, -0.026250, -0.033750
#*# 	-0.047500, 0.011250, 0.000000, -0.010000, -0.051250
#*# 	-0.025000, -0.007500, 0.041250, -0.012500, -0.001250
#*# 	-0.020000, 0.036250, 0.087500, 0.052500, -0.011250
#*# tension = 0.2
#*# min_x = 40.0
#*# algo = bicubic
#*# y_count = 5
#*# mesh_y_pps = 2
#*# min_y = 40.0
#*# x_count = 5
#*# max_y = 260.0
#*# mesh_x_pps = 2
#*# max_x = 260.0
#*#
#*# [bed_mesh After Gantry Work and Klicky]
#*# version = 1
#*# points =
#*# 	0.055000, 0.043750, 0.056250, 0.061250, 0.065000
#*# 	0.008750, 0.017500, 0.036250, 0.031250, 0.012500
#*# 	0.031250, 0.040000, 0.000000, 0.023750, -0.020000
#*# 	0.043750, 0.041250, 0.040000, 0.065000, 0.031250
#*# 	0.096250, 0.111250, 0.092500, 0.113750, 0.101250
#*# tension = 0.2
#*# min_x = 40.0
#*# algo = bicubic
#*# y_count = 5
#*# mesh_y_pps = 2
#*# min_y = 40.0
#*# x_count = 5
#*# max_y = 260.0
#*# mesh_x_pps = 2
#*# max_x = 260.0
#*#
#*# [skew_correction CaliFlower]
#*# xy_skew = -0.0016106312140954815
#*# xz_skew = 0.0
#*# yz_skew = 0.0
#*#
#*# [scanner model default]
#*# model_coef = 1.2937173329964842,
#*# 	  1.7240846768034623,
#*# 	  0.7439246489612344,
#*# 	  0.27815632463618073,
#*# 	  0.4994862466603282,
#*# 	  0.7459873980147053,
#*# 	  -0.3837244018897622,
#*# 	  -0.7584799125087659,
#*# 	  0.39680030099115765,
#*# 	  0.4620621960757428
#*# model_domain = 3.146498513774213e-07,3.356353577344319e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 27.179647
#*# model_offset = 0.00000
#*#
#*# [scanner]
#*# scanner_touch_threshold = 2750
